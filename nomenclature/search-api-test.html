<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<style type="text/css">
			input, select {height: 50px;}
			#search-input {
				width: 100%;
				padding: 10px;
				font-size: 1.2em;
			}
			#search {
				position: relative;
				display: inline-block;
				width: 60%;
				margin-top: 10px;
			}
			#search-list {
				position: absolute;
				max-height: 600px;
				overflow: auto;
				top: 100%;
				left: 0;
				right: 0;
				border: 1px solid #d4d4d4;
				border-top: none;
				z-index: 99;
			}
			#search-list div {
				padding: 10px;
			}
			#search-list div:hover {
				background-color: lightgrey;
				cursor: pointer;
			}
			dt {
				font-weight: bold;
			}
		</style>
	</head>
	<body>
		<h1>Nomenclature</h1>
		<section>
		    <form action="" method="GET">
		        <!-- <select id="term-order">
		            <option value="natural" selected>Natural</option>
		            <option value="inverted">Inverted</option>
		        </select> -->
		        <select id="lang">
		            <option value="en" selected>English</option>
		            <option value="en-CA">Canadian English</option>
		            <option value="fr">French</option>
		            <option value="fr-CA">Canadian French</option>
		            <option value="es">Spanish</option>
		            <option value="iu">Inuktitut</option>
		            <option value="iu-Latn">Inuktitut (Latin)</option>
		        </select>
		        <div id="search">
		            <input type="search" name="termSearch" id="search-input"/>
		            <div id="search-list"></div>
		        </div>
		        <input type="submit" value="Display" disabled/>
		    </form>
		</section>

		<script>
		    const searchInput = document.querySelector("#search-input");
		    const searchList = document.querySelector("#search-list");

		    function removeAllChildNodes(parent) {
		        while (parent.firstChild) {
		            parent.removeChild(parent.firstChild);
		        }
		    };

		    function parse(data){
		        // const termOrder = document.querySelector("#term-order").value;
		        if (data.length > 0) {
		            for (const r of data) {
		                if (r.prefLabel) {
		                    const display = {};
		                    const pageUrl = r.mainEntityOfPage;

		                    for (label of r.prefLabel) {
		                        const val = label.literalForm.value;
		                        const lang = label.literalForm.language;
		                        display[lang] = val;
		                    }

		                    // if (termOrder == 'inverted' && 'altLabel' in r) {
		                    //     for (alt of r.altLabel) {
		                    //         const altVal = alt.literalForm.value;
		                    //         const altLang = alt.literalForm.language;
		                    //         // missing type in search api result
		                    //         // if (alt.type){
		                    //         //  display[altLang] = altVal;
		                    //         // }
		                    //         if (altVal.includes(', ')){
		                    //             display[altLang] = altVal;
		                    //         }
		                    //     }
		                    // }
		                    r['display'] = display;
		                }
		            }
		        }
		        // console.log(data)
		        return data 
		    };

		    searchInput.addEventListener("input", () => {
		        removeAllChildNodes(searchList);
		        
		        const query = encodeURIComponent(searchInput.value);
		        const language = document.querySelector("#lang").value;
		        const url = "https://nomenclature.info/api/v1/search?"
		                    + "termSearch=" + query
		                    + "&lang=" + language;

		        let xhr = new XMLHttpRequest();
		        xhr.open('GET',url,true)
		        xhr.setRequestHeader('Accept', 'application/json');
		        xhr.onreadystatechange = function() {
		            if (this.readyState == 4 && this.status == 200) {
		                // Typical action to be performed when the document is ready:
		                let results = parse(JSON.parse(this.response));
		                for (const r of results) {
		                    const display = r['display'];
		                    if (language in display) {
		                        const rq = r.self + "?lang=" + language;
		                        searchList.innerHTML += `<div onclick="getData('${rq}')">${display[language]} (${language})</div>\n`;
		                    } else {
		                        const langRep = language.replace('-CA','').replace('-Latn','');
		                        const rq = r.self + "?lang=" + langRep;
		                        // searchList.innerHTML += `<div><a href="${pageUrl}" target="_blank">${display[langRep]} (${langRep})</a></div>\n`;
		                        searchList.innerHTML += `<div onclick="getData('${rq}')">${display[langRep]} (${langRep})</div>\n`;
		                    }
		                }
		            }
		        };
		        xhr.send();
		        
		    });
		    /*execute a function when someone clicks in the document:*/
		    document.addEventListener("click", () => {
		        removeAllChildNodes(searchList);
		    });

		</script>

		
	</body>
</html>